name: Deploy to GitHub Pages

on:
  push:
    branches: [main, 'claude/fix-mobile-scan-buttons-5iEUw']
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Single root install — sets up workspace symlinks for @echos/core, @echos/ui,
      # and hoists all devDependencies (vite, etc.) into root node_modules.
      # DO NOT add a second npm install inside apps/web — it breaks workspace links.
      - name: Install dependencies
        run: npm install

      - name: Verify workspace resolution
        working-directory: apps/web
        run: |
          set -euo pipefail
          echo "=== Verifying workspace packages are resolvable ==="
          node -e "require.resolve('@echos/core')" && echo "OK: @echos/core resolves" || { echo "FAIL: @echos/core not found"; exit 1; }
          node -e "require.resolve('@echos/ui')" && echo "OK: @echos/ui resolves" || { echo "FAIL: @echos/ui not found"; exit 1; }
          node -e "require.resolve('vite')" && echo "OK: vite resolves" || { echo "FAIL: vite not found"; exit 1; }
          echo "All workspace dependencies verified."

      # Use --workspace flag from root — this is the most reliable way to run
      # a build in an npm workspace. It correctly sets up PATH, resolves all
      # workspace symlinks, and finds the hoisted vite binary.
      # DO NOT use "npx vite build" — npx may download a separate vite copy
      # that lacks project context, producing an empty 58 KB bundle.
      - name: Build web app
        run: npm run build --workspace=apps/web

      - name: Add .nojekyll
        run: touch apps/web/dist/.nojekyll

      - name: HARD FAIL — verify build output
        run: |
          set -euo pipefail

          echo "=== Checking apps/web/dist/index.html ==="
          if [ ! -f apps/web/dist/index.html ]; then
            echo "FAIL: apps/web/dist/index.html does NOT exist"
            exit 1
          fi
          echo "OK: index.html exists"

          echo "=== Checking apps/web/dist/assets/ ==="
          if [ ! -d apps/web/dist/assets ]; then
            echo "FAIL: apps/web/dist/assets/ directory does NOT exist — Vite did not bundle JS/CSS"
            exit 1
          fi
          ASSET_COUNT=$(ls -1 apps/web/dist/assets/ | wc -l)
          if [ "$ASSET_COUNT" -lt 1 ]; then
            echo "FAIL: apps/web/dist/assets/ is empty — no JS/CSS bundles"
            exit 1
          fi
          echo "OK: assets/ contains $ASSET_COUNT files"

          echo "=== Checking total dist size ==="
          DIST_SIZE_KB=$(du -sk apps/web/dist | cut -f1)
          echo "Dist size: ${DIST_SIZE_KB} KB"
          if [ "$DIST_SIZE_KB" -lt 300 ]; then
            echo "FAIL: dist is only ${DIST_SIZE_KB} KB — expected >= 300 KB for a real Vite build"
            exit 1
          fi
          echo "OK: dist size ${DIST_SIZE_KB} KB >= 300 KB"

          echo "=== Checking SPA index.html has script tag ==="
          if ! grep -q '<script' apps/web/dist/index.html; then
            echo "FAIL: index.html has no <script> tag — not a Vite build output"
            exit 1
          fi
          echo "OK: index.html contains script references"

          echo "=== Checking .nojekyll ==="
          if [ ! -f apps/web/dist/.nojekyll ]; then
            echo "FAIL: .nojekyll not found"
            exit 1
          fi
          echo "OK: .nojekyll present"

          echo ""
          echo "=== Full dist listing ==="
          ls -laR apps/web/dist/
          echo ""
          du -sh apps/web/dist/
          echo ""
          echo "ALL CHECKS PASSED"

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: apps/web/dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
